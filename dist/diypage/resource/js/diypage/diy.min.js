define(['jquery.ui'], function(ui) {



	var iswyrq = 0;



	var modal = {

		sysinfo: null,

		id: 0,

		type: 1,

		navs: {},

		initnav: [],

		data: {},

		selected: 'page',

		childid: null,

		keyworderr: false,

		iswyrq : 0

	};



	/*_________________*/

	modal.navs = {
			video: {

                name: '直播',

                icon: '#icondangeshipin',

                style: {

                    ratio: '0',

                    background:'#ffffff',

                    mt:'10',

                    paddingleft:'10',

                    paddingtop:'10'

                },

                params: {

                    videourl: '',

                    poster: ASSETS+'resource/images/diypage/default/videoplay.png',

                    videostyle:'0',
										styledata:'0',
										repeat:'repeat',

										positionx:'left',
					
										positiony:'top',
					
										size:'0',
                    backgroundimg:'',

										autoplay:'0',

                }

           },
		banner: {

		name: '图片轮播',

		icon: '#icontupianlunbo',

		params: {

			totle:2,

			navstyle:0,

			styledata:'0',

			repeat:'repeat',

			positionx:'left',

			positiony:'top',

			size:'0',

			backgroundimg:'',

			navstyle2:0,

		},

		style: {

			dotstyle: 'round',

			dotalign: 'left',

			paddingtop:'10',

			paddingleft:'10',

			background: '#ffffff',

			backgroundall: '#ffffff',

			leftright: '5',

			bottom: '5',

			opacity: '0.8',

			text_color:'#fff',

			bg:'#000000',

			jsq_color:'red',

			pdh:'0',

			pdw:'0',

			mt:'10',

			sizew:'20',

			sizeh:'20',

			speed:'5',

		},

		data: {

			C0123456789101: {

				imgurl: ASSETS+'resource/images/diypage/default/bigimgshow.jpg',

				linkurl: '',

				single:1,

				text:'文字描述'

			},

			C0123456789102: {

				imgurl: ASSETS+'resource/images/diypage/default/bigimgshow.jpg',

				linkurl: '',

				single:2,

				text:'文字描述'

			}

		}

	},menu: {

		name: '按钮组',

		icon: '#iconanniuzu',

		params: {

			styledata:'0',

			repeat:'repeat',

			positionx:'left',

			positiony:'top',

			size:'0',

			backgroundimg:'',

			picicon:'1',
			
			textshow:'1'

		},

		style: {

			navstyle: 'circle',

			background: '#ffffff',

			rownum: '4',

			showtype: '0',

			pagenum: '8',

			showdot: '1',

			padding:'0',

			paddingleft:'10',

			mt:'10',

			sizew:'20',

			sizeh:'20',

			iconfz:'14',

			iconcolor:'#434343',

			imgwidth:'50'

		},

		data: {

			C0123456789101: {

				imgurl: ASSETS+'resource/images/diypage/default/icon-1.png',

				linkurl: '',

				text: '按钮文字',

				color: '#666666',

				icon:'icon-x-shouye2',

				iconclass:'icon-x-shouye2'


			},

			C0123456789102: {

				imgurl: ASSETS+'resource/images/diypage/default/icon-2.png',

				linkurl: '',

				text: '按钮文字',

				color: '#666666',

				icon:'icon-x-shouye2',

				iconclass:'icon-x-shouye2'

			},

			C0123456789103: {

				imgurl: ASSETS+'resource/images/diypage/default/icon-3.png',

				linkurl: '',

				text: '按钮文字',

				color: '#666666',

				icon:'icon-x-shouye2',

				iconclass:'icon-x-shouye2'

			},

			C0123456789104: {

				imgurl: ASSETS+'resource/images/diypage/default/icon-4.png',

				linkurl: '',

				text: '按钮文字',

				color: '#666666',

				icon:'icon-x-shouye2',

				iconclass:'icon-x-shouye2'

			},

			C0123456789105: {

				imgurl: ASSETS+'resource/images/diypage/default/icon-4.png',

				linkurl: '',

				text: '按钮文字',

				color: '#666666',

				icon:'icon-x-shouye2',

				iconclass:'icon-x-shouye2'

			},

			C0123456789106: {

				imgurl: ASSETS+'resource/images/diypage/default/icon-3.png',

				linkurl: '',

				text: '按钮文字',

				color: '#666666',

				icon:'icon-x-shouye2',

				iconclass:'icon-x-shouye2'

			},

			C0123456789107: {

				imgurl: ASSETS+'resource/images/diypage/default/icon-2.png',

				linkurl: '',

				text: '按钮文字',

				color: '#666666',

				icon:'icon-x-shouye2',

				iconclass:'icon-x-shouye2'

			},

			C0123456789108: {

				imgurl: ASSETS+'resource/images/diypage/default/icon-1.png',

				linkurl: '',

				text: '按钮文字',

				color: '#666666',

				icon:'icon-x-shouye2',

				iconclass:'icon-x-shouye2'

			}

		}

	},
	ssk: {

		name:'搜索栏',

		icon:'#iconsousuolan',

		params:{

			value:'',

			styledata:'0',

		 repeat:'repeat',

		 positionx:'left',

		 positiony:'top',

		 size:'0',

		 backgroundimg:'',

		},

		style:{

			textalign:'left',

			background:'#ffffff',

			bg:'#ffffff',

			borderradius:'5',

			boxpdh:'10',

			boxpdz:'15',

			padding:'5',

			fontsize:'13',

			mt:'0',

			sizew:'20',

		 sizeh:'20',

		 color:'#cccccc'

		}

},richtext: {

	name: '富文本',

	max: 5,

	icon: '#iconfuwenben',

	params: {

		content: ''

	},

	style: {

		'background': '#ffffff',

		'padding': '10',

		'margintop':'10'

	}

},
}



	/*__________________*/

	jQuery.base64 = (function($) {

		var _PADCHAR = "=",

			_ALPHA = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",

			_VERSION = "1.1";



		function _getbyte64(s, i) {

			var idx = _ALPHA.indexOf(s.charAt(i));

			if(idx === -1) {

				throw "Cannot decode base64"

			}

			return idx

		}



		function _decode_chars(y, x) {

			while(y.length > 0) {

				var ch = y[0];

				if(ch < 0x80) {

					y.shift();

					x.push(String.fromCharCode(ch))

				} else if((ch & 0x80) == 0xc0) {

					if(y.length < 2) break;

					ch = y.shift();

					var ch1 = y.shift();

					x.push(String.fromCharCode(((ch & 0x1f) << 6) + (ch1 & 0x3f)))

				} else {

					if(y.length < 3) break;

					ch = y.shift();

					var ch1 = y.shift();

					var ch2 = y.shift();

					x.push(String.fromCharCode(((ch & 0x0f) << 12) + ((ch1 & 0x3f) << 6) + (ch2 & 0x3f)))

				}

			}

		}



		function _decode(s) {

			var pads = 0,

				i, b10, imax = s.length,

				x = [],

				y = [];

			s = String(s);

			if(imax === 0) {

				return s

			}

			if(imax % 4 !== 0) {

				throw "Cannot decode base64"

			}

			if(s.charAt(imax - 1) === _PADCHAR) {

				pads = 1;

				if(s.charAt(imax - 2) === _PADCHAR) {

					pads = 2

				}

				imax -= 4

			}

			for(i = 0; i < imax; i += 4) {

				var ch1 = _getbyte64(s, i);

				var ch2 = _getbyte64(s, i + 1);

				var ch3 = _getbyte64(s, i + 2);

				var ch4 = _getbyte64(s, i + 3);

				b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12) | (_getbyte64(s, i + 2) << 6) | _getbyte64(s, i + 3);

				y.push(b10 >> 16);

				y.push((b10 >> 8) & 0xff);

				y.push(b10 & 0xff);

				_decode_chars(y, x)

			}

			switch(pads) {

				case 1:

					b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12) | (_getbyte64(s, i + 2) << 6);

					y.push(b10 >> 16);

					y.push((b10 >> 8) & 0xff);

					break;

				case 2:

					b10 = (_getbyte64(s, i) << 18) | (_getbyte64(s, i + 1) << 12);

					y.push(b10 >> 16);

					break

			}

			_decode_chars(y, x);

			if(y.length > 0) throw "Cannot decode base64";

			return x.join("")

		}



		function _get_chars(ch, y) {

			if(ch < 0x80) y.push(ch);

			else if(ch < 0x800) {

				y.push(0xc0 + ((ch >> 6) & 0x1f));

				y.push(0x80 + (ch & 0x3f))

			} else {

				y.push(0xe0 + ((ch >> 12) & 0xf));

				y.push(0x80 + ((ch >> 6) & 0x3f));

				y.push(0x80 + (ch & 0x3f))

			}

		}



		function _encode(s) {

			if(arguments.length !== 1) {

				throw "SyntaxError: exactly one argument required"

			}

			s = String(s);

			if(s.length === 0) {

				return s

			}

			var i, b10, y = [],

				x = [],

				len = s.length;

			i = 0;

			while(i < len) {

				_get_chars(s.charCodeAt(i), y);

				while(y.length >= 3) {

					var ch1 = y.shift();

					var ch2 = y.shift();

					var ch3 = y.shift();

					b10 = (ch1 << 16) | (ch2 << 8) | ch3;

					x.push(_ALPHA.charAt(b10 >> 18));

					x.push(_ALPHA.charAt((b10 >> 12) & 0x3F));

					x.push(_ALPHA.charAt((b10 >> 6) & 0x3f));

					x.push(_ALPHA.charAt(b10 & 0x3f))

				}

				i++

			}

			switch(y.length) {

				case 1:

					var ch = y.shift();

					b10 = ch << 16;

					x.push(_ALPHA.charAt(b10 >> 18) + _ALPHA.charAt((b10 >> 12) & 0x3F) + _PADCHAR + _PADCHAR);

					break;

				case 2:

					var ch1 = y.shift();

					var ch2 = y.shift();

					b10 = (ch1 << 16) | (ch2 << 8);

					x.push(_ALPHA.charAt(b10 >> 18) + _ALPHA.charAt((b10 >> 12) & 0x3F) + _ALPHA.charAt((b10 >> 6) & 0x3f) + _PADCHAR);

					break

			}

			return x.join("")

		}



		return {

			decode: _decode,

			encode: _encode,

			VERSION: _VERSION

		}

	}(jQuery));



	modal.init = function(params) {

		window.tpl = params.tpl;

		modal.iswyrq = 0;

		modal.attachurl = params.attachurl;

		modal.type = params.type;

		modal.data = params.data;

		modal.siteid = params.siteid;

		modal.id = params.id;

		modal.diyform = params.diyform;

		modal.companyinfo = params.companyinfo;

		modal.merch = params.merch;

		modal.plugins = params.plugins ? params.plugins : {};

		modal.shopset = params.shopset;

		if(modal.data) {

			if(modal.data.page){

				modal.type = modal.data.page.type;

			}

			modal.page = modal.data.page;

			modal.items = modal.data.items

		};

		modal.initTpl();

		modal.initPage();

		modal.initItems();

		modal.initNavs();

		modal.initSortable();

		modal.initGotop();
		
		$(".btn-save").unbind('click').click(function() {

			var _this = $(this);

			var status = _this.data('status');

			var type = _this.data('type');

			var id = _this.data('id');

			var _tplid = _this.data('tplid');


			if (status) {



				tip.msgbox.err("正在保存，请稍候。。。");

				return

			}


			if(type == 'savetemp') {

				modal.initTemp();

				return;

			} else if(type == 'tempset') {

				modal.tempSet();

				return;

			} else {

				modal.save(type, id, _this,_tplid);

			}

		});

		$("#page").unbind('click').click(function() {

			if(modal.selected == 'page') {

				return

			};

			modal.selected = 'page';

			modal.initPage()

		});

		// var preview_id = util.cookie.get('preview_id');

		// if(preview_id) {

		// 	setTimeout(function() {

		// 		var previewUrl = biz.url("company/diypage/preview") + "&id=" + preview_id;

		// 		window.open(previewUrl)

		// 	}, 1000);

		// 	util.cookie.set('preview_id', '')

		// }

	};



	function contains(arrays, obj) {
		var i = arrays.length;
		while (i--) {
			if (arrays[i] === obj) {
				return i;
			}
		}
		return false;
	}



	modal.initNavs = function() {

		// if(id != null && name != null && value != null){

		// 	modal.getNavs(id,name,value);

		// }else{

		// 	modal.getNavs();

		// }

		var navgroup = {


			0: ['listmenu','dp', 'title2', 'bigimg', 'classfit', 'personlist', 'logo', 'richtext', 'title', 'line', 'blank', 'menu', 'menu2', 'picture','msmk', 'banner', 'service','copyright','picturew','mlist','multiple', 'pt', 'notice','anniu','tcgg','ssk','yhq','xnlf', 'goods', 'tabbar','dnfw', 'kpgg','cases', 'joblist','xfk','contact', 'listdesc','supply','dt','wyrq', 'feedback', 'footmenu', 'video','yuyin', 'ad','ddlb', 'reserve', 'bargain','msmk','supply','multiple','mlist','reserve','pt','bargain']

		};

		var customPageList = [{

			'name': 'common',

			'arr': []

		}, {

			'name': 'content',

			'arr': []

		}, {

			'name': 'marketing',

			'arr': []

		}, {

			'name': 'special',

			'arr': []

		},];

		var navpage = navgroup[0];

		var plugin_ba = document.getElementById('plugin_ba').value
		var plugin_ms = document.getElementById('plugin_ms').value
		var plugin_yu = document.getElementById('plugin_yu').value
		var plugin_sp = document.getElementById('plugin_sp').value
		var plugin_pt = document.getElementById('plugin_pt').value
		var plugin_ds = document.getElementById('plugin_ds').value
		if(!plugin_ba){
			navpage.splice(contains(navpage, 'bargain'), 1)
		}

		if(!plugin_ms){
			navpage.splice(contains(navpage, 'msmk'), 1)
		}

		if(!plugin_yu){
			navpage.splice(contains(navpage, 'reserve'), 1)
		}

		if(!plugin_sp){
			navpage.splice(contains(navpage, 'supply'), 1)
		}

		if(!plugin_pt){
			navpage.splice(contains(navpage, 'pt'), 1)
		}

		if(!plugin_ds){
			navpage.splice(contains(navpage, 'mlist'), 2)
		}
		console.log(navpage);
		$.each(navpage, function(index, val) {

			var params = modal.navs[val];

			if(params) {

				params.id = val;

				if(val == 'merchgroup' && (!modal.plugins.merch || modal.merch)) {

					return true

				}

				if(val == 'seckillgroup' && (!modal.plugins.seckill || modal.seckill)) {

					return true

				}

				if(val == 'detail_seckill' && (!modal.plugins.seckill || modal.seckill)) {

					return true

				}

				

				modal.initnav.push(params);

			}

		});
		
		$.each(customPageList, function(index, item) {
			
			
			$.each(modal.navs, function(key, value) {

				var id = value.id;
				if(index === 0 && (id == 'title' || id == 'richtext' || id == 'line' || id == 'blank' || id == 'anniu' || id == 'menu' || id == 'menu2' || id == 'banner' || id == 'picture' || id == 'picturew' || id == 'copyright' || id == 'title2' || id == 'bigimg' || id == 'classfit' || id=='ddlb' )) {

					customPageList[index]['arr'].push(value);

				} else if(index === 1 && (id == 'notice' || id == 'cases' || id == 'listdesc' || id == 'supply' || id == 'goods' || id == 'pt' || id == 'msmk' || id == 'tabbar' || id =='multiple' || id=="mlist"  || id == 'personlist' || id == 'reserve' || id =='bargain' || id=='supply' || id == 'msmk' || id=='multiple' || id=='mlist' || id=='reserve' || id=='pt' || id=='bargain' )) {
					//'multiple','mlist'，'reserve','pt','bargain'
					customPageList[index]['arr'].push(value);

				} else if(index === 2 && (id == 'ad' || id == 'ssk' || id == 'xnlf'  || id == 'xfk' || id == 'dt' || id == 'yhq' || id == 'dnfw' || id == 'yuyin' || id == 'joblist' || id == 'contact' || id == 'video' || id == 'listmenu' || id == 'service' || id == 'logo' || id == 'dp')) {

					customPageList[index]['arr'].push(value);

				} else if(index === 3 && (id == 'kpgg' || id == 'tcgg' || id == 'wyrq' || id == 'footmenu' || id == 'feedback')) {

					customPageList[index]['arr'].push(value);

				}

			})

		});

		modal.initnav = customPageList;

		var html = tpl("tpl_navs", modal);

		$("#navs").html(html).show();

		$(".page_nav").unbind('click').click(function() {


			var id = $(this).data('id');

			if(typeof id === 'undefined') {

				return;

			}

			if(id === 'page') {

				$("#page").trigger("click");

				return

			}

			if(id == 'merchgroup' && !modal.plugins.merch) {

				tip.msgbox.err("禁止添加此元素！");

				return

			}

			if((id == 'seckillgroup' || id == 'detail_seckill') && !modal.plugins.seckill) {

				tip.msgbox.err("禁止添加此元素！");

				return

			}

			var inArray = $.inArray(id, navpage);

			if(inArray < 0) {

				tip.msgbox.err("此页面类型禁止添加此元素！");

				return

			}

			var item = $.extend(true, {}, modal.navs[id]);

			modal.navs[id].index+=1;

			modal.initNavs();

			delete item.name;

			if(!item) {

				tip.msgbox.err("未找到此元素！");

				return

			}

			var itemTplShow = $("#tpl_show_" + id).length;

			var itemTplEdit = $("#tpl_edit_" + id).length;


			if(itemTplShow == 0 || itemTplEdit == 0) {

				tip.msgbox.err("添加失败！模板错误，请刷新页面重试");

				return

			}

			if(id === 'diymod') {

				modal.initMod(item);

				return

			}

			var itemid = modal.getId("M", 0);



			if(item.data) {

				var itemData = $.extend(true, {}, item.data);

				var newData = {};

				var index = 0;

				$.each(itemData, function(id, data) {

					var childid = modal.getId("C", index);

					newData[childid] = data;

					delete childid;

					index++

				});

				item.data = newData

			}

			if(item.max && item.max > 0) {

				var itemNum = modal.getItemNum(id);





				if(iswyrq == 1){

					tip.msgbox.err("不能添加其他组件");

					return false;		

				}

				if(id == 'wyrq'){

					var count = 1;

					$.each(modal.items,function(k,v){

						count++;

					});

					if(count > 1){

						tip.msgbox.err("网页容器不能与其他组件共存");

						return false;

					}

					iswyrq = 1;

				}

				// if(id == 'copyright'){

				// 	var count = 1;

				// 	$.each(modal.items,function(k,v){

				// 		count++;

				// 	});

				// 	if(count > 1){

				// 		tip.msgbox.err("网页容器不能与其他组件共存");

				// 		return false;

				// 	}

				// 	iswyrq = 1;

				// }

				

				if(itemNum > 0 && itemNum >= item.max) {

					tip.msgbox.err("此元素最多允许添加 " + item.max + " 个");

					return

				}

			}

			if(id != 'wyrq'){

				if(iswyrq == 1){

					tip.msgbox.err("不能添加其他组件");

					return false;		

				}

			}



			var append = true;

			if(modal.selected && modal.selected != 'page') {

				var thisitem = modal.items[modal.selected];

				if(thisitem.id == 'detail_navbar' || thisitem.id == 'detail_pullup' || id == 'detail_navbar' || id == 'detail_pullup') {

					append = false

				}

			}



			if(item.istop || item.isfoot) {

				var newItems = {};

				if (item.istop) {

					newItems[itemid] = item;

				}

				$.each(modal.items, function(id, eachitem) {

					newItems[id] = eachitem

				});

				if (item.isfoot) {

					newItems[itemid] = item;

				}

				modal.items = newItems

			} else if(modal.selected && modal.selected != 'page' && append) {

				var newItems = {};

				$.each(modal.items, function(id, eachitem) {

					if(id == modal.selected && eachitem.isfoot) {

						newItems[itemid] = item

					}

					newItems[id] = eachitem;

					if(id == modal.selected && !eachitem.isfoot) {

						newItems[itemid] = item

					}

				});

				modal.items = newItems

			} else {

				if(modal.page.type == 5 && modal.items && id != 'detail_navbar') {

					var navbar = null;

					var pullup = null;

					$.each(modal.items, function(newitemid, newitem) {

						if(newitem.id == 'detail_navbar') {

							navbar = {

								itemid: newitemid,

								item: newitem

							};

							delete modal.items[newitemid]

						} else if(newitem.id == 'detail_pullup') {

							pullup = {

								itemid: newitemid,

								item: newitem

							};

							delete modal.items[newitemid]

						}

					});

					modal.items[itemid] = item;

					if(pullup) {

						modal.items[pullup.itemid] = pullup.item

					}

					if(navbar) {

						modal.items[navbar.itemid] = navbar.item

					}

				} else {

					modal.items[itemid] = item

				}

			};

			modal.initItems();

			$(".drag[data-itemid='" + itemid + "']").trigger('mousedown').trigger('click');

			modal.selected = itemid

		})

	};

	modal.getId = function(S, N) {

		var date = +new Date();

		var id = S + (date + N);

		return id

	};

	modal.getNavs = function(itemid = null,name = null,value = null) {

		if(itemid != null && name != null && value != null){

			modal.navs[itemid].index = value;

		}

	};

	modal.initItems = function(selected) {

		var phone = $("#phone");

		if(!modal.items) {

			modal.items = {};

			return

		}

		phone.empty();

		

		$.each(modal.items, function(itemid, item) {

			if(typeof(item.id) !== 'undefined') {

				var newItem = $.extend(true, {}, item);

				newItem.itemid = itemid;

				if(item.id == 'audio') {

					newItem.shoplogo = modal.shopset ? modal.shopset.logo : ''

				}

				if(item.id == 'contact'){

					newItem.companyinfo = modal.companyinfo;

				}

				if(item.id == 'feedback'){
					
					var fId = item.params.formid;

					if(fId!='0' && fId != undefined){

						$.each(modal.diyform, function(index, item) {

							var diyId = item.id;

							if(diyId == fId) {

								newItem.diyform = item;

								return false;

							}

						})

					}

				}

				var html = tpl("tpl_show_" + item.id, newItem);
				// console.log(html,'html')

				$("#phone").append(html)

			}


		});

		var btnhtml = $("#edit-del").html();

		$("#phone .drag").append(btnhtml);

		$("#phone .drag .btn-edit-del .btn-del").unbind('click').click(function(e) {

			e.stopPropagation();

			var drag = $(this).closest(".drag");

			var itemid = drag.data('itemid');



			var nodelete = $(this).closest(".drag").hasClass("nodelete");

			if(nodelete) {

				tip.alert("此元素禁止删除");

				return

			}

			tip.confirm("确定删除吗", function() {









				var nearid = modal.getNear(itemid);

				delete modal.items[itemid];

				modal.initItems();

				if(nearid) {

					$(document).find(".drag[data-itemid='" + nearid + "']").trigger('mousedown');

				} else {

					$("#page").trigger('click')

				}

			})

		});

		if(selected) {

			modal.selectedItem(selected)

		}

	};

	modal.selectedItem = function(itemid) {

		if(!itemid) {

			return

		}

		modal.selected = itemid;

		if(itemid == 'page') {

			$("#page").trigger('click')

		} else {

			$(".drag[data-itemid='" + itemid + "']").addClass('selected')

		}

	};

	modal.initPage = function(initE) {

		if(typeof(initE) === 'undefined') {

			initE = true

		}



		if(!modal.page) {

			modal.page = {

				type: modal.type,

				title: '请输入页面标题',

				name: '未命名页面',

				background: 'rgb(241, 241, 241)',

				topbackground: '#ffffff',

				topcolor: '1',

				styledata:'0',

				repeat:'',

				positionx:'0',

				positiony:'0',

				size:'0',

				sizew:'20',

				sizeh:'20',

				// url:ASSETS+'resource/images/diypage/default/goods-1.jpg'

			};

			if(modal.type == 5) {

				modal.page.title = "产品详情"

			} else if(modal.type == 8) {

				modal.page.title = "兑换中心"

			} else if(modal.type == 99) {

				modal.page.type = 99;

				modal.page.title = '公用模块';

				modal.page.name = '未命名模块'

			}

		}

		if(!modal.page.visitlevel) {

			modal.page.visitlevel = {

				member: null,

				commission: null

			};

		}

		if(!modal.page.novisit) {

			modal.page.novisit = {};

		}

		$("#page").text(modal.page.title).css({

			color: modal.page.topcolor == 1 ? '#000000' : '#FFFFFF',

			backgroundColor: modal.page.topbackground

		});

		$("#phone").css({

			'background-color': modal.page.background



		});

		$('#phone').css('background-image', 'url("'+modal.page.url+'")');

		$("#phone").css('background-repeat',modal.page.repeat);

		$("#phone").css('background-position-x',modal.page.positionx);

		$("#phone").css('background-position-y',modal.page.positiony);

		if(modal.page.size==1){

			$("#phone").css('background-size','cover')

		}

		if(modal.page.size==0){

			$("#phone").css('background-size',''+modal.page.sizew+'% '+modal.page.sizeh+'%')

		}

		$("#phone").find(".drag").removeClass("selected");

		if(initE) {

			modal.initEditor()

		}

		modal.initTilteBg()

	};

	modal.initTilteBg = function() {

		var RgbValue = $('#page')[0].style.backgroundColor.replace("rgb(", "").replace(")", "");

		var RgbValueArry = RgbValue.split(",");

		var grayLevel = RgbValueArry[0] * 0.299 + RgbValueArry[1] * 0.587 + RgbValueArry[2] * 0.114;

		var imgsrc = grayLevel > 192 ? 'wx-top2' : 'wx-top';

		$('#page').css('background-image', 'url('+ASSETS+'"resource/images/diypage/' + imgsrc + '.png")')

	};

	modal.initSortable = function() {

		$("#phone").sortable({

			opacity: 0.8,

			placeholder: "highlight",

			items: '.drag:not(.fixed)',

			revert: 100,

			scroll: false,

			start: function(event, ui) {

				var height = ui.item.height();

				$(".highlight").css({

					"height": height + "px"

				});

				$(".highlight").html('<div><i class="fa fa-plus"></i> 放置此处</div>');

				$(".highlight div").css({

					"line-height": height - 4 + "px"

				})

			},

			stop: function(event, ui) {

				modal.initEditor()

			},

			update: function(event, ui) {

				modal.sortItems()

			}

		});

		$("#phone").disableSelection();

		$(document).on('mousedown', "#phone .drag", function() {

			if($(this).hasClass("selected")) {

				return

			}

			modal.selected = $(this).data('itemid');

			$("#phone").find(".drag").removeClass("selected");

			$(this).addClass("selected");

			modal.selected = $(this).data('itemid');

			modal.initEditor()

		})

	};

	modal.sortItems = function() {

		var newItems = {};

		$("#phone .drag").each(function() {

			var thisid = $(this).data('itemid');

			newItems[thisid] = modal.items[thisid]

		});

		modal.items = newItems

		console.log(modal.items);

	};

	modal.initEditor = function(scroll) {

		if(typeof(scroll) === 'undefined') {

			scroll = true

		}

		var itemid = modal.selected;

		var top = 180;

		if(modal.selected != 'page') {

			var stop = $(".selected").position().top;

			top = stop ? stop : 0

		}

//		      if (scroll) {

//		          $("#diy-editor").unbind('animate').animate({"margin-top": top - 130 + "px"});

//		          setTimeout(function () {

//		              $("body").unbind('animate').animate({scrollTop: top - 130 + "px"}, 1000)

//		          }, 1000)

//		      }

		if(modal.selected) {

			if(modal.selected == 'page') {

				if(modal.type == 99) {

					var html = tpl("tpl_edit_page_mod", modal.page)

				} else {

					var html = tpl("tpl_edit_page", modal)

				}

				$("#diy-editor .inner").html(html)

			} else {

				var item = $.extend(true, {}, modal.items[modal.selected]);

				item.itemid = modal.selected;

				item.merch = modal.merch;

				item.plugins = modal.plugins;

				item.diyform = modal.diyform;

//				console.log(item,'item');

				var html = tpl("tpl_edit_" + item.id, item);

				$("#diy-editor .inner").html(html)

			}

			$("#diy-editor").attr("data-editid", modal.selected).show()

		}

		var sliderlength = $("#diy-editor .slider").length;

		if(sliderlength > 0) {

			$("#diy-editor .slider").each(function() {

				var decimal = $(this).data('decimal');

				var multiply = $(this).data('multiply');

				var defaultValue = $(this).data("value");

				if(decimal) {

					defaultValue = defaultValue * decimal

				}

				$(this).slider({

					slide: function(event, ui) {

						var sliderValue = ui.value;

						if(decimal) {

							sliderValue = sliderValue / decimal

						}

						$(this).siblings(".input").val(sliderValue).trigger("propertychange");

						$(this).siblings(".count").find("span").text(sliderValue)

					},

					value: defaultValue,

					min: $(this).data("min"),

					max: $(this).data("max")

				})

			})

		}

		var goodsSelector = $("#diy-editor .goods-selector").length;

		if(goodsSelector > 0) {

			var _this = $("#diy-editor .goods-selector");

			var url = biz.url('company/goods/query');

			_this.attr({

				'id': 'goods_selector',

				'data-url': url,

				'data-callback': 'callbackGoods'

			});

			_this.unbind('click').click(function() {

				biz.selector.select({

					name: 'goods'

				});

				modal.childid = $(this).closest('.item').data('id')

			})

		}

		var casesSelector = $("#diy-editor .cases-selector").length;

		if(casesSelector) {

			var _this = $("#diy-editor .cases-selector");

			var url = biz.url('company/case/query');

			_this.attr({

				'id': 'cases_selector',

				'data-url': url,

				'data-callback': 'callbackCases'

			});

			_this.unbind('click').click(function() {

				biz.selector.select({

					name: 'cases'

				});

				modal.childid = $(this).closest('.item').data('id')

			})

		}

		var listdescSelector = $("#diy-editor .listdesc-selector").length;

		if(listdescSelector) {

			var _this = $("#diy-editor .listdesc-selector");

			var url = biz.url('company/news/category&getcategory=1');

			_this.attr({

				'id': 'listdesc_selector',

				'data-url': url,

				'data-callback': 'callbackListdesc'

			});

			_this.unbind('click').click(function() {

				biz.selector.select({

					name: 'listdesc'

				});

				modal.childid = $(this).closest('.item').data('id')

			})

		}

		var newsSelector = $("#diy-editor .news-selector").length;

		if(newsSelector) {

			var _this = $("#diy-editor .news-selector");

			var url = biz.url('company/news/query');

			_this.attr({

				'id': 'news_selector',

				'data-url': url,

				'data-callback': 'callbackNews'

			});

			_this.unbind('click').click(function() {

				biz.selector.select({

					name: 'news'

				});

				modal.childid = $(this).closest('.item').data('id')

			})

		}

		var childitems = $("#diy-editor .form-items").length;

		if(childitems > 0) {

			modal.initSortableChild();

			$("#addChild").unbind('click').click(function() {

				var itemid = modal.selected;

				var type = modal.items[itemid].id;

				var temp = modal.navs[type].data;

				var max = $(this).closest(".form-items").data('max');

				if(max) {

					var length = modal.length(modal.items[itemid].data);

					if(length >= max) {

						tip.msgbox.err("最大添加 " + max + " 个！");

						return

					}

				}

				var newChild = {};

				var index = 0;

				$.each(temp, function(i, t) {

					if(index == 0) {

						newChild = t;

						index++

					}

				});

				if(newChild) {

					var childName = modal.getId("M", 0);

					if(typeof(modal.items[itemid].data) === 'undefined') {

						modal.items[itemid].data = {}

					}

					newChild = $.extend(true, {}, newChild);

					modal.items[itemid].data[childName] = newChild

				}

				modal.initItems(itemid);

				modal.initEditor(false)

			});

			$("#diy-editor .form-items .item .btn-del").unbind('click').click(function() {

				var childid = $(this).closest(".item").data('id');

				var itemid = modal.selected;

				var min = $(this).closest(".form-items").data("min");

				if(min) {

					var length = modal.length(modal.items[itemid].data);

					if(length <= min) {

						tip.msgbox.err("至少保留 " + min + " 个！");

						return

					}

				}

				tip.confirm("确定删除吗", function() {



					delete modal.items[itemid].data[childid];

					modal.initItems(itemid);

					modal.initEditor(false)

				})

			})

		}

		var richtext = $("#diy-editor .form-richtext").length;

		if(richtext > 0) {

			var ueditoroption = {

				'autoClearinitialContent': false,

				'toolbars': [
					//'map', 'anchor', 'drafts', 
					['fullscreen', 'source', '|', 'bold', 'italic', 'underline', 'strikethrough', 'forecolor', 'backcolor', '|', 'justifyleft', 'justifycenter', 'justifyright', '|', 'insertorderedlist', 'insertunorderedlist', 'blockquote',  'removeformat', '|', 'rowspacingtop', 'rowspacingbottom', 'lineheight', 'indent', 'paragraph', 'fontsize', '|', 'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', '|', 'print']

				],

				'elementPathEnabled': false,

				'initialFrameHeight': 300,

				'focus': false,

				'maximumWords': 9999999999999

			};

			var opts = {

				type: 'image',

				direct: false,

				multiple: true,

				tabs: {

					'upload': 'active',

					'browser': '',

					'crawler': ''

				},

				path: '',

				dest_dir: '',

				global: false,

				thumb: false,

				width: 0

			};

			UE.registerUI('myinsertimage', function(editor, uiName) {
				console.log(111112222)

				editor.registerCommand(uiName, {

					execCommand: function() {
						console.log(12321321)
						uploadphoto1.click();
						// $("#uploadphoto1").click(function(){
					 //        $("#myupload1").ajaxSubmit({ 
					 //          dataType:  'json', //数据格式为json 
					 //          success: function(data) {
					 //          	console.log(1)
					 //          	console.log(data)
					 //            var url = $.parseJSON(data)['url'];
					 //            console.log(url)
					 //          }
					 //        }).change(); 
						// });
						
					   


						// require(['fileUploader'], function(uploaderss) {

						// 	uploaderss.show(function(imgs) {

						// 		if(imgs.length == 0) {

						// 			return

						// 		} else if(imgs.length == 1) {

						// 			editor.execCommand('insertimage', {

						// 				'src': imgs[0]['url'],

						// 				'_src': imgs[0]['url'],

						// 				'width': '100%',

						// 				'alt': imgs[0].filename

						// 			})

						// 		} else {

						// 			var imglist = [];

						// 			for(i in imgs) {

						// 				imglist.push({

						// 					'src': imgs[i]['url'],

						// 					'_src': imgs[i]['url'],

						// 					'width': '100%',

						// 					'alt': imgs[i].filename

						// 				})

						// 			}

						// 			editor.execCommand('insertimage', imglist)

						// 		}

						// 	}, opts)

						// })

						

						require(['jquery', "util"], function($, util) {

							/*修改图片选择方式，以及加载方式*/

							util.image('', function(imgs) {

								if(imgs.length == 0) {

									return

								} else if(imgs.length == 1) {

									editor.execCommand('insertimage', {

										'src': imgs[0]['url'],

										'_src': imgs[0]['url'],

										'width': '100%',

										'alt': imgs[0].filename

									})

								} else {

									var imglist = [];

									for(i in imgs) {

										imglist.push({

											'src': imgs[i]['url'],

											'_src': imgs[i]['url'],

											'width': '100%',

											'alt': imgs[i].filename

										})

									}

									editor.execCommand('insertimage', imglist)

								}

							},opts)

						})

					}

				});

				var btn = new UE.ui.Button({

					name: '插入图片',

					title: '插入图片',

					cssRules: 'background-position: -726px -77px',

					onclick: function() {

						editor.execCommand(uiName)

					}

				});

				editor.addListener('selectionchange', function() {

					var state = editor.queryCommandState(uiName);

					if(state == -1) {

						btn.setDisabled(true);

						btn.setChecked(false)

					} else {

						btn.setDisabled(false);

						btn.setChecked(state)

					}

				});

				return btn

			}, 48);

			// UE.registerUI('myinsertvideo', function(editor, uiName) {

			// 	editor.registerCommand(uiName, {

			// 		execCommand: function() {

			// 			require(['fileUploader'], function(uploader) {

			// 				uploader.show(function(video) {

			// 					if(!video) {

			// 						return

			// 					} else {

			// 						var videoType = video.isRemote ? 'iframe' : 'video';

			// 						editor.execCommand('insertvideo', {

			// 							'url': video.url,

			// 							'width': 300,

			// 							'height': 200

			// 						}, videoType)

			// 					}

			// 				}, {

			// 					fileSizeLimit: 5120000,

			// 					type: 'video',

			// 					allowUploadVideo: true

			// 				})

			// 			})

			// 		}

			// 	});

			// 	var btn = new UE.ui.Button({

			// 		name: '插入视频',

			// 		title: '插入视频',

			// 		cssRules: 'background-position: -320px -20px',

			// 		onclick: function() {

			// 			editor.execCommand(uiName)

			// 		}

			// 	});

			// 	editor.addListener('selectionchange', function() {

			// 		var state = editor.queryCommandState(uiName);

			// 		if(state == -1) {

			// 			btn.setDisabled(true);

			// 			btn.setChecked(false)

			// 		} else {

			// 			btn.setDisabled(false);

			// 			btn.setChecked(state)

			// 		}

			// 	});

			// 	return btn

			// }, 20);

			UE.registerUI('mylink', function(editor, uiName) {

				var btn = new UE.ui.Button({

					name: 'selectUrl',

					title: '系统链接',

					cssRules: 'background-position: -622px 80px;',

					onclick: function() {

						$("#" + this.id).attr({

							"data-toggle": "selectUrl",

							"data-callback": "selectUrlCallback",

							"data-uniacid":$("#diy-editor .form-richtext").data("uniacid")

						})

					}

				});

				editor.addListener('selectionchange', function() {

					var state = editor.queryCommandState(uiName);

					if(state == -1) {

						btn.setDisabled(true);

						btn.setChecked(false)

					} else {

						btn.setDisabled(false);

						btn.setChecked(state)

					}

				});

				return btn

			});

			if(typeof(UE) != 'undefined') {

				UE.delEditor('rich')

			}

			var ue = UE.getEditor('rich', ueditoroption);

			ue.ready(function() {

				var thisitem = modal.items[itemid];

				var richContent = thisitem.params.content;

				richContent = $.base64.decode(richContent);

				ue.setContent(richContent);

				ue.addListener('contentChange', function() {

					var newContent = ue.getContent();

					newContent = $.base64.encode(newContent);

					$("#richtext").html(newContent).trigger('change')

				})

			})

		}

		/*页面组件的BIND操作*/

		$("#diy-editor").find(".diy-bind").bind('input propertychange change', function() {

			var _this = $(this);

			var bind = _this.data("bind");

			var bindchild = _this.data('bind-child');

			var bindparent = _this.data('bind-parent');

			var initEditor = _this.data('bind-init');

			var value = '';

			var tag = this.tagName;

			if(!itemid) {

				modal.selectedItem('page ')

			}

			if(tag == 'INPUT') {

				var type = _this.attr('type');

				if(type == 'checkbox') {

					value = [];

					_this.closest('.form-group').find('input[type=checkbox]').each(function() {

						var checked = this.checked;

						var valname = $(this).val();

						if(checked) {

							value.push(valname)

						}

					})

				} else {

					var placeholder = _this.data('placeholder');

					value = _this.val();

					value = value == '' ? placeholder : value

				}

			} else if(tag == 'SELECT') {

				value = _this.find('option:selected').val()

			} else if(tag == 'TEXTAREA') {

				value = _this.val()

			}

			value = $.trim(value);

			if(itemid == 'page') {

				if(bindchild) {

					if(!modal.page[bindchild]) {

						modal.page[bindchild] = {}

					}

					modal.page[bindchild][bind] = value

				} else {

					modal.page[bind] = value

				}

				modal.initPage(false);

				if(bind == 'keyword') {

					$.post(biz.url('company/diypage/keyword'), {

						id: modal.id,

						keyword: value

					}, function(r) {

						if(r.status == 0) {

							_this.closest('.form-group').addClass('has-error');

							modal.keyworderr = true

						} else {

							_this.closest('.form-group').removeClass('has-error');

							modal.keyworderr = false

						}

					}, 'json')

				}

			} else {

				if(bindchild) {

					if(bindparent) {

						modal.items[itemid][bindparent][bindchild][bind] = value

					} else {

						modal.items[itemid][bindchild][bind] = value

					}

				} else {

					modal.items[itemid][bind] = value

				}

				modal.initItems(itemid)

			}

			if(initEditor) {

				modal.initEditor(false)

			}

		})

	};

	modal.initSortableChild = function() {

		$("#diy-editor .inner").sortable({

			opacity: 0.8,

			placeholder: "highlight",

			items: '.item',

			revert: 100,

			scroll: false,

			cancel: '.goods-selector,input,select,.btn,btn-del',

			start: function(event, ui) {

				var height = ui.item.height();

				$(".highlight").css({

					"height": height + 22 + "px"

				});

				$(".highlight").html('<div><i class="fa fa-plus"></i> 放置此处</div>');

				$(".highlight div").css({

					"line-height": height + 16 + "px"

				})

			},

			update: function(event, ui) {

				modal.sortChildItems()

			}

		})

	};

	modal.initMod = function(item) {

		$.ajax(biz.url('company/diypage/mod/query', null, modal.merch), {

			type: "get",

			dataType: "html",

			cache: false

		}).done(function(html) {

			modModal = $('<div class="modal fade" id="modModal"></div>');

			$(document.body).append(modal), modModal.modal('show');

			modModal.append2(html, function() {

				$(document).off("click", '#modModal nav').on("click", '#modModal nav', function() {

					var modid = $(this).data('id');

					var modname = $(this).data('name');

					modModal.find(".close").click();

					var itemid = modal.getId("M", 0);

					item.params.modid = modid;

					item.params.modname = modname;

					if(modal.selected && modal.selected != 'page') {

						var newItems = {};

						$.each(modal.items, function(id, eachitem) {

							newItems[id] = eachitem;

							if(id == modal.selected) {

								newItems[itemid] = item

							}

						});

						modal.items = newItems

					} else {

						modal.items[itemid] = item

					}

					modal.initItems();

					$(".drag[data-itemid='" + itemid + "']").trigger('mousedown').trigger('click');

					modal.selected = itemid

				})

			})

		})

	};

	modal.initTemp = function() {
		$("#saveTempModal").modal();

		$("#saveTemp", "#saveTempModal").unbind('click').click(function() {

			var tempname = $.trim($("#saveTempModal").find("#saveTempName").val());

			var classid = $.trim($("#saveTempModal").find("#saveClassid").val());

			var temppreview = $.trim($("#saveTempModal").find("#feedbackbgimg").val());


            var templateid = $("input[name='template_id']").val();

            var _uniacid = $("#saveTempModal").find("#saveTempName").data('uniacid');

            var ids = [];

            $(".table-responsive tbody").find('tr').each(function () {

                var id = $(this).find('td').eq(0).attr('data-id');

                ids.push(id);

            });
            if(classid == 0) {

				tip.msgbox.err("请选择模板分类！");

				$("#saveTempModal").find("#saveTempName").focus();

				return

			}
			if(!tempname) {

				tip.msgbox.err("请填写模板名称！");

				$("#saveTempModal").find("#saveTempName").focus();

				return

			}

			$("#saveTempModal .close").trigger('click');

			var static = document.getElementById('staticroot').value

			if(static){
				static = static + '/index.php'
			}


			// var posturl = biz.url("site/entry/diy",'&m=sudu8_page&&op=make&opt=settemplate')
			var posturl = static + "/index/diypage/index?op=settemplate&appletid="+_uniacid;

			$.post(posturl, {

                templateid: templateid,

                name: tempname,

                classid:classid,

                preview: temppreview,

                ids : ids

			}, function(ret) {

				if(ret.status == 0) {

					tip.msgbox.err(ret.result.message)

				} else {

					tip.msgbox.suc("另存为模板保存成功！")

					// setTimeout(function () {

					// 	window.location.href = "/index/diypage/index?appletid="+_uniacid+"&tplid="+ret.id;

     //                },2000);

				}

			}, 'json')

		})

	};

	modal.tempSet = function() {

		$("#TempSetModal").modal();

		$("#TempSet", "#TempSetModal").unbind('click').click(function() {

			var tempname = $.trim($("#TempSetModal").find("#TempSetName").val());

			var temppreview = $.trim($("#TempSetModal").find("#feedbackbgimg").val());

			var templateid = $("input[name='template_id']").val();

			var _uniacid = $("#TempSetModal").find("#TempSetName").data('uniacid');

			var ids = [];

			$(".table-responsive").find('tr').each(function () {

				var id = $(this).find('td').eq(1).attr('data-id');

				ids.push(id);

            });

			if(!tempname) {

				tip.msgbox.err("请填写模板名称！");

				$("#TempSetModal").find("#TempSetName").focus();

				return

			}

			$("#TempSetModal .close").trigger('click');

			var static = document.getElementById('staticroot').value

			if(static){
				static = static + '/index.php'
			}

			var posturl = static + "/index/diypage/index?op=settemp&appletid="+_uniacid;
			
			// var posturl = biz.url("site/entry/Diy",'&m=sudu8_page&op=make')

			$.post(posturl, {

                templateid: templateid,

				name: tempname,

				preview: temppreview,

                ids : ids

			}, function(ret) {

				if(ret.status == 0) {

					tip.msgbox.err(ret.result.message)

				} else {

					tip.msgbox.suc("模板设置保存成功！")

				}

			}, 'json')

		})

	};

	modal.initTpl = function() {

		tpl.helper("imgsrc", function(src) {

			if(typeof src != 'string') {

				return ''

			}

			if(src.indexOf('http://') == 0 || src.indexOf('https://') == 0 || src.indexOf('./resource/') == 0) {

				return src

			} else if(src.indexOf('images/') == 0 || src.indexOf('audios/') == 0 || src.indexOf('videos/') == 0) {

				return modal.attachurl + src

			}

		});

		tpl.helper("decode", function(content) {

			return $.base64.decode(content)

		});

		tpl.helper("count", function(data) {

			return modal.length(data)

		});

		tpl.helper("toArray", function(data) {

			var oldArray = $.makeArray(data);

			var newArray = [];

			$.each(data, function(itemid, item) {

				newArray.push(item)

			});

			return newArray

		});

		tpl.helper("strexists", function(str, tag) {

			if(!str || !tag) {

				return false

			}

			if(str.indexOf(tag) != -1) {

				return true

			}

			return false

		});

		tpl.helper("inArray", function(str, tag) {

			if(!str || !tag) {

				return false

			}

			if(typeof(str) == 'string') {

				var arr = str.split(",");

				if($.inArray(tag, arr) > -1) {

					return true;

				}

			}

			return false

		});

		tpl.helper("define", function(str) {

			var str

		})

	};

	modal.initGotop = function() {

		$(window).bind('scroll resize', function() {

			var scrolltop = $(window).scrollTop();

			if(scrolltop > 300) {

				$("#gotop").show()

			} else {

				$("#gotop").hide()

			}

			$("#gotop").unbind('click').click(function() {

				$('body').animate({

					scrollTop: "0px"

				}, 1000)

			})

		})

	};

	modal.getNear = function(itemid) {

		var newarr = [];

		var index = 0;

		var prev = 0;

		var next = 0;

		$.each(modal.items, function(id, obj) {

			newarr[index] = id;

			if(id == itemid) {

				prev = index - 1;

				next = index + 1

			}

			index++

		});

		var pervid = newarr[prev];

		var nextid = newarr[next];

		if(nextid) {

			return nextid

		}

		if(pervid) {

			return pervid

		}

		return false

	};

	modal.getItemNum = function(id) {

		if(!id || !modal.items) {

			return -1

		}

		var itemNum = 0;

		$.each(modal.items, function(itemid, eachitem) {

			if(eachitem.id == id) {

				itemNum++

			}

		});

		return itemNum

	};

	modal.sortChildItems = function() {

		var newChild = {};

		var itemid = modal.selected;

		$("#diy-editor .form-items .item").each(function() {

			var thisid = $(this).data('id');

			newChild[thisid] = modal.items[itemid].data[thisid]

		});

		modal.items[itemid].data = newChild;

		modal.initItems(itemid)

	};

	modal.length = function(json) {

		if(typeof(json) === 'undefined') {

			return 0

		}

		var jsonlen = 0;

		for(var item in json) {

			jsonlen++

		}

		return jsonlen

	};

	modal.callbackGoods = function(data) {

		if(!data) {

			tip.msgbox.err("回调数据错误，请重试！");

			return

		}

		var itemid = modal.selected;

		var childid = modal.childid;

		modal.items[itemid].data[childid] = {

			'title': data.title,

			'thumb': data.thumb,

			'productprice': data.oldprice,

			'price': data.nowprice,

			'gid': data.id

		};

		modal.initItems(itemid);

		modal.initEditor(false);

		modal.childid = null

	};

	modal.callbackCases = function(data) {

		if(!data) {

			tip.msgbox.err("回调数据错误，请重试！");

			return

		}

		var itemid = modal.selected;

		var childid = modal.childid;

		modal.items[itemid].data[childid] = {

			'title': data.title,

			'imgurl': data.thumb,

			'id': data.id

		};

		modal.initItems(itemid);

		modal.initEditor(false);

		modal.childid = null

	};

	modal.callbackListdesc = function(data) {

		if(!data) {

			tip.msgbox.err("回调数据错误，请重试！");

			return

		}

		var itemid = modal.selected;

		modal.items[itemid].params.title = data.title;

		modal.items[itemid].params.titleid = data.id;

		modal.initItems(itemid);

		modal.initEditor(false);

		modal.childid = null;

	};

	modal.callbackNews = function(data) {

		if(!data) {

			tip.msgbox.err("回调数据错误，请重试！");

			return

		}

		var itemid = modal.selected;

		var childid = modal.childid;

		modal.items[itemid].data[childid] = {

			'title': data.title,

			'thumb': data.thumb,

			'time': data.createtime,

			'id': data.id

		};

		modal.initItems(itemid);

		modal.initEditor(false);

		modal.childid = null

	};

	/*页面组件数据操作*/

	modal.save = function(type, editid, _this,_tplid) {

		if(typeof(type) === 'undefined') {

			type = false;

		}

		if(type && modal.type == 5) {

			tip.msgbox.err("产品详情页涉及产品数据问题，请至手机端预览");

			return;

		}

		modal.data = {};

		modal.data = {

			page: modal.page,

			items: modal.items

		};

		if(!modal.page.title) {

			tip.msgbox.err("页面标题是必填项");

			$("#page").trigger("click");

			return;

		}
	 _this.hasClass('save-page') ? _this.data('status', 1).text("保存中...") : '';
		//console.log(JSON.stringify(modal.data));return false;
		var parmars = {
			   id: modal.id,
			   name:modal.page.name,
			   type:'1',
			   managerType:'0',
			   items:JSON.stringify(modal.data.items),
			   pages:JSON.stringify(modal.data.page),
			//    siteid: modal.siteid,
			//    tplid:_tplid
		}
	if(!id) {
		delete parmars.id
		parmars.coverImg = 'https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1596716214376&di=95406fc7bbd626b9af38327e5bb8f089&imgtype=0&src=http%3A%2F%2Fhbimg.huabanimg.com%2F76ecabb9925cf296c82639d050fae4600e7202671d83c-devKWh_fw658'
	}
	$.ajax({
		url:modal.id?update_url:save_url,
		type:'PUT',
		headers:{
			'content-type':'application/json'
		},
		data:JSON.stringify(parmars),
		success(res) {
			console.log(res)
			if(res.status==200) {
				layer.msg('保存成功',function() {
					location.href = '/index.html'
				})
			}
		}
	})
	//   $.put(save_url, {
	// //    id: modal.id,
	//    name:'页面名称',
	//    type:'1',
	//    managerType:'0',
	//    items:JSON.stringify(modal.data.items),
	//    pages:JSON.stringify(modal.data.pages),
	// //    siteid: modal.siteid,
	// //    tplid:_tplid
	//   }, function(ret) {
	//    if(ret.status == 0) {
	//     tip.msgbox.suc("保存成功");
	//     $(".btn-save[data-type='save']").text("保存页面").data("status", 0);
	//     $(".btn-save[data-type='savetemp']").text("另存为模板").data("status", 0);
	//     if(ret.id > 0){
	//      	setTimeout(function () {
	//       		window.location.href = window.location.href;
	//       	},1000);
	//     }
	//     return;
	//    }else{
	//         tip.msgbox.err(ret.message)
	//    }
	//    $(".btn-save[data-type='save']").text("保存页面").data("status", 0);
	//    $(".btn-save[data-type='savetemp']").text("另存为模板").data("status", 0);
	//   }, 'json')
	 };
	 modal.length = function(json) {
	  if(typeof(json) === 'undefined') {
	   return 0
	  }
	  var jsonlen = 0;
	  for(var item in json) {
	   jsonlen++
	  }
	  return jsonlen
	 };
	 return modal

});